name: Kubernetes Cluster create/destroy

on:
  workflow_dispatch:
    inputs:

      action:
        description: "Action"
        required: true
        type: choice
        options:
          - create
          - destroy

      node_name:
        description: "Proxmox node"
        required: true
        default: proxmox


jobs:

  cluster:

    runs-on: self-hosted

    defaults:
      run:
        working-directory: proxmox/terraform

    env:
      TF_IN_AUTOMATION: true
      TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
      TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
      TF_VAR_node_name: ${{ github.event.inputs.node_name }}


    steps:

    ############################################################
    # Checkout repository
    ############################################################

    - name: Checkout repo
      uses: actions/checkout@v4


    ############################################################
    # Setup SSH key (needed for destroy)
    ############################################################

    - name: Setup SSH key
      if: github.event.inputs.action == 'destroy'
      run: |
        mkdir -p ~/.ssh
        rm -f ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub
        echo "${{ secrets.PROXMOX_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub
        ssh-keyscan -H ${{ secrets.PROXMOX_HOST }} >> ~/.ssh/known_hosts


    ############################################################
    # Terraform init
    ############################################################

    - name: Terraform init
      if: github.event.inputs.action == 'create'
      run: terraform init -upgrade -input=false


    ############################################################
    # CREATE MASTER VM (separate state)
    ############################################################

    - name: Create master VM
      if: github.event.inputs.action == 'create'
      run: terraform apply -auto-approve -input=false -state=cluster-master.tfstate
      env:
        TF_VAR_vm_name: master
        TF_VAR_template_name: ubuntu24-golden
        TF_VAR_vm_memory_mb: 4096
        TF_VAR_disk_size_gb: 32
        TF_VAR_ip_address: 192.168.1.20


    ############################################################
    # CREATE WORKER1 VM (separate state)
    ############################################################

    - name: Create worker1 VM
      if: github.event.inputs.action == 'create'
      run: terraform apply -auto-approve -input=false -state=cluster-worker1.tfstate
      env:
        TF_VAR_vm_name: worker1
        TF_VAR_template_name: ubuntu24-golden
        TF_VAR_vm_memory_mb: 4096
        TF_VAR_disk_size_gb: 32
        TF_VAR_ip_address: 192.168.1.21


    ############################################################
    # CREATE WORKER2 VM (separate state)
    ############################################################

    - name: Create worker2 VM
      if: github.event.inputs.action == 'create'
      run: terraform apply -auto-approve -input=false -state=cluster-worker2.tfstate
      env:
        TF_VAR_vm_name: worker2
        TF_VAR_template_name: ubuntu24-golden
        TF_VAR_vm_memory_mb: 4096
        TF_VAR_disk_size_gb: 32
        TF_VAR_ip_address: 192.168.1.22


    ############################################################
    # DESTROY ALL CLUSTER VMs SAFELY
    ############################################################

    - name: Destroy cluster VMs
      if: github.event.inputs.action == 'destroy'
      run: |

        for VM in master worker1 worker2
        do

          echo "Processing $VM"

          VMID=$(ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            ${{ secrets.PROXMOX_SSH_USER }}@${{ secrets.PROXMOX_HOST }} \
            "qm list | grep -w $VM | awk '{print \$1}'")

          if [ -z "$VMID" ]; then
            echo "$VM not found, skipping"
            continue
          fi

          echo "Stopping $VM (VMID=$VMID)"

          ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            ${{ secrets.PROXMOX_SSH_USER }}@${{ secrets.PROXMOX_HOST }} \
            "qm stop $VMID || true"

          sleep 5

          echo "Destroying $VM (VMID=$VMID)"

          ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            ${{ secrets.PROXMOX_SSH_USER }}@${{ secrets.PROXMOX_HOST }} \
            "qm destroy $VMID --purge"

          echo "$VM destroyed"

        done


    ############################################################
    # DONE
    ############################################################

    - name: Done
      run: echo "Cluster operation completed successfully"
