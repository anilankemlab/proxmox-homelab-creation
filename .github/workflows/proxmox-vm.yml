name: Proxmox VM create/destroy

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action"
        required: true
        type: choice
        options:
          - create
          - destroy

      vm_name:
        description: "VM name"
        required: true
        type: string

      node_name:
        description: "Proxmox node"
        required: true
        type: string
        default: proxmox

      template:
        description: "Template"
        required: false
        type: choice
        options:
          - ubuntu24-golden
          - centos10-stream-golden

      ram_mb:
        description: "RAM (MB)"
        required: false
        type: number
        default: 2048

      disk_gb:
        description: "Disk size (GB)"
        required: false
        type: number
        default: 20

      ip_address:
        description: "Static IP address (optional)"
        required: false
        type: string

jobs:
  proxmox:
    runs-on: self-hosted

    defaults:
      run:
        working-directory: proxmox/terraform

    env:
      TF_IN_AUTOMATION: true
      TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
      TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
      TF_VAR_node_name: ${{ github.event.inputs.node_name }}
      TF_VAR_vm_name: ${{ github.event.inputs.vm_name }}

    steps:
      ############################################################
      # Checkout repository
      ############################################################

      - name: Checkout repo
        uses: actions/checkout@v4

      ############################################################
      # CREATE VM USING TERRAFORM
      ############################################################

      - name: Create state directory
        if: github.event.inputs.action == 'create'
        run: mkdir -p /home/ansible/terraform_state/vms

      - name: Terraform init
        if: github.event.inputs.action == 'create'
        run: terraform init -upgrade -input=false

      - name: Terraform apply
        if: github.event.inputs.action == 'create'
        run: terraform apply -auto-approve -input=false -state=/home/ansible/terraform_state/vms/${{ github.event.inputs.vm_name }}.tfstate
        env:
          TF_VAR_template_name: ${{ github.event.inputs.template }}
          TF_VAR_vm_memory_mb: ${{ github.event.inputs.ram_mb }}
          TF_VAR_disk_size_gb: ${{ github.event.inputs.disk_gb }}
          TF_VAR_ip_address: ${{ github.event.inputs.ip_address }}

      ############################################################
      # Setup SSH key for Proxmox access
      ############################################################

      - name: Setup SSH key for Proxmox
        if: github.event.inputs.action == 'create'
        run: |
          mkdir -p ~/.ssh
          rm -f ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub
          echo "${{ secrets.PROXMOX_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub
          ssh-keyscan -H ${{ secrets.PROXMOX_HOST }} >> ~/.ssh/known_hosts

      ############################################################
      # Get VM IP from Proxmox guest agent (reliable DHCP detection)
      ############################################################

      - name: Get VM IP from Proxmox
        if: github.event.inputs.action == 'create'
        run: |
          VMID=$(terraform output -state=/home/ansible/terraform_state/vms/${{ github.event.inputs.vm_name }}.tfstate -raw vm_id)

          echo "VMID is $VMID"

          for i in {1..30}; do
            VM_IP=$(ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
              ${{ secrets.PROXMOX_SSH_USER }}@${{ secrets.PROXMOX_HOST }} \
              "qm guest cmd $VMID network-get-interfaces 2>/dev/null | jq -r '.[] | select(.name != \"lo\") | .\"ip-addresses\"[] | select(.\"ip-address-type\"==\"ipv4\") | .\"ip-address\"' | head -n 1")

            if [[ ! -z "$VM_IP" && "$VM_IP" != "127.0.0.1" ]]; then
              echo "VM_IP=$VM_IP" >> $GITHUB_ENV
              echo "VM IP is $VM_IP"
              exit 0
            fi

            echo "Waiting for VM IP..."
            sleep 5
          done

          echo "Failed to get VM IP"
          exit 1

      ############################################################
      # Create Ansible inventory
      ############################################################

      - name: Create Ansible inventory
        if: github.event.inputs.action == 'create'
        run: |
          mkdir -p ansible

          cat <<EOF > ansible/inventory.ini
          [newvm]
          $VM_IP ansible_user=root ansible_ssh_private_key_file=~/.ssh/id_ed25519 ansible_ssh_common_args='-o StrictHostKeyChecking=no' ansible_python_interpreter=/usr/bin/python3
          EOF

          echo "Inventory created:"
          cat ansible/inventory.ini

      ############################################################
      # Wait for SSH ready and add to known_hosts
      ############################################################

      - name: Wait for SSH and add host key
        if: github.event.inputs.action == 'create'
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

          echo "Waiting for SSH on $VM_IP..."

          until ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$VM_IP 'echo SSH ready' 2>/dev/null; do
            echo "SSH not ready yet... waiting 10 seconds"
            sleep 10
          done

          ssh-keyscan -H "$VM_IP" >> ~/.ssh/known_hosts 2>/dev/null || true

          echo "SSH ready"

      ############################################################
      # Add Ansible to PATH
      ############################################################

      - name: Add Ansible to PATH
        if: github.event.inputs.action == 'create'
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      ############################################################
      # Verify Ansible
      ############################################################

      - name: Verify Ansible
        if: github.event.inputs.action == 'create'
        run: |
          which ansible
          which ansible-playbook
          ansible --version

      ############################################################
      # Run Ansible bootstrap
      ############################################################

      - name: Run Ansible bootstrap
        if: github.event.inputs.action == 'create'
        run: ansible-playbook -i ansible/inventory.ini ansible/bootstrap.yml

      ############################################################
      # DESTROY VM USING TERRAFORM
      ############################################################

      - name: Terraform init (destroy)
        if: github.event.inputs.action == 'destroy'
        run: terraform init -upgrade -input=false

      - name: Terraform destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform apply -destroy -auto-approve -input=false -state=/home/ansible/terraform_state/vms/${{ github.event.inputs.vm_name }}.tfstate
        env:
          TF_VAR_template_name: ${{ github.event.inputs.template }}
          TF_VAR_vm_memory_mb: ${{ github.event.inputs.ram_mb }}
          TF_VAR_disk_size_gb: ${{ github.event.inputs.disk_gb }}
          TF_VAR_ip_address: ${{ github.event.inputs.ip_address }}

      - name: Cleanup state file
        if: github.event.inputs.action == 'destroy'
        run: rm -f /home/ansible/terraform_state/vms/${{ github.event.inputs.vm_name }}.tfstate
