name: Proxmox VM create/destroy

on:
  workflow_dispatch:
    inputs:

      action:
        description: "Action"
        required: true
        type: choice
        options:
          - create
          - destroy

      vm_name:
        description: "VM name"
        required: true
        type: string

      node_name:
        description: "Proxmox node"
        required: true
        type: string
        default: proxmox

      template:
        description: "Template"
        required: false
        type: choice
        options:
          - ubuntu24-golden
          - centos10-stream-golden

      ram_mb:
        description: "RAM (MB)"
        required: false
        type: number
        default: 2048

      disk_gb:
        description: "Disk size (GB)"
        required: false
        type: number
        default: 20

      ip_address:
        description: "Static IP address"
        required: false
        type: string


jobs:
  proxmox:

    runs-on: self-hosted

    defaults:
      run:
        working-directory: proxmox/terraform

    env:
      TF_IN_AUTOMATION: true
      TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
      TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
      TF_VAR_node_name: ${{ github.event.inputs.node_name }}
      TF_VAR_vm_name: ${{ github.event.inputs.vm_name }}

    steps:

      ############################################################
      # Checkout repository
      ############################################################

      - name: Checkout repo
        uses: actions/checkout@v4


      ############################################################
      # CREATE VM USING TERRAFORM
      ############################################################

      - name: Terraform init
        if: github.event.inputs.action == 'create'
        run: terraform init -upgrade -input=false


      - name: Terraform apply
        if: github.event.inputs.action == 'create'
        run: terraform apply -auto-approve -input=false
        env:
          TF_VAR_template_name: ${{ github.event.inputs.template }}
          TF_VAR_vm_memory_mb: ${{ github.event.inputs.ram_mb }}
          TF_VAR_disk_size_gb: ${{ github.event.inputs.disk_gb }}
          TF_VAR_ip_address: ${{ github.event.inputs.ip_address }}


      ############################################################
      # Get VM IP from Terraform output
      ############################################################

      - name: Get VM IP
        if: github.event.inputs.action == 'create'
        run: |
          VM_IP=$(terraform output -raw vm_ip)
          echo "VM_IP=$VM_IP" >> $GITHUB_ENV
          echo "VM IP is $VM_IP"


      ############################################################
      # Create Ansible inventory dynamically
      ############################################################

      - name: Create Ansible inventory
        if: github.event.inputs.action == 'create'
        run: |
          mkdir -p ansible

          cat <<EOF > ansible/inventory.ini
          [newvm]
          $VM_IP ansible_user=root ansible_ssh_private_key_file=~/.ssh/id_ed25519 ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

          echo "Inventory created:"
          cat ansible/inventory.ini

      - name: Add Vm to known_hosts
        if: github.event.inputs.action == 'create'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H $VM_IP >> ~/.ssh/known_hosts

      ############################################################
      # Run Ansible bootstrap playbook
      ############################################################

      - name: Run Ansible bootstrap
        if: github.event.inputs.action == 'create'
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/bootstrap.yml


      ############################################################
      # DESTROY VM USING SSH (STATELESS)
      ############################################################

      - name: Setup SSH key
        if: github.event.inputs.action == 'destroy'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROXMOX_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.PROXMOX_HOST }} >> ~/.ssh/known_hosts


      - name: Destroy VM on Proxmox
        if: github.event.inputs.action == 'destroy'
        run: |
          echo "Looking for VM: ${{ github.event.inputs.vm_name }}"

          VMID=$(ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.PROXMOX_SSH_USER }}@${{ secrets.PROXMOX_HOST }} \
            "qm list | grep -w '${{ github.event.inputs.vm_name }}' | awk '{print \$1}'")

          if [ -z "$VMID" ]; then
            echo "VM not found"
            exit 0
          fi

          echo "Found VMID: $VMID"

          echo "Stopping VM..."
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.PROXMOX_SSH_USER }}@${{ secrets.PROXMOX_HOST }} \
            "qm stop $VMID || true"

          echo "Waiting for VM to stop..."
          sleep 5

          echo "Destroying VM..."
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.PROXMOX_SSH_USER }}@${{ secrets.PROXMOX_HOST }} \
            "qm destroy $VMID --purge"

          echo "VM destroyed successfully"
