name: Proxmox VM create/destroy

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - create
          - destroy
        default: create
      template:
        description: "Template to clone from"
        required: true
        type: choice
        options:
          - ubuntu24-golden
          - centos10-stream-golden
      vm_name:
        description: "Name of the VM"
        required: true
        type: string
      ram_mb:
        description: "RAM in MB"
        required: true
        type: number
        default: 2048
      disk_gb:
        description: "Disk size in GB"
        required: true
        type: number
        default: 20
      node_name:
        description: "Proxmox node (e.g. pve)"
        required: true
        type: string
        default: proxmox

jobs:
  proxmox-vm:
    runs-on: self-hosted

    env:
      TF_IN_AUTOMATION: "true"
      TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
      TF_VAR_proxmox_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
      TF_VAR_proxmox_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
      TF_VAR_node_name: ${{ github.event.inputs.node_name }}
      TF_VAR_vm_name: ${{ github.event.inputs.vm_name }}
      TF_VAR_template_name: ${{ github.event.inputs.template }}
      TF_VAR_vm_memory_mb: ${{ github.event.inputs.ram_mb }}
      TF_VAR_disk_size_gb: ${{ github.event.inputs.disk_gb }}

    defaults:
      run:
        working-directory: proxmox/terraform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          if ! [[ "${{ github.event.inputs.vm_name }}" =~ ^[a-zA-Z0-9-]+$ ]]; then
            echo "Error: VM name must contain only alphanumeric characters and hyphens."
            exit 1
          fi
          if ! [[ "${{ github.event.inputs.ram_mb }}" =~ ^[0-9]+$ ]] || [[ "${{ github.event.inputs.ram_mb }}" -le 0 ]]; then
            echo "Error: RAM must be a positive number."
            exit 1
          fi
          if ! [[ "${{ github.event.inputs.disk_gb }}" =~ ^[0-9]+$ ]] || [[ "${{ github.event.inputs.disk_gb }}" -le 0 ]]; then
            echo "Error: Disk size must be a positive number."
            exit 1
          fi
        shell: bash

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform apply (create)
        if: ${{ github.event.inputs.action == 'create' }}
        run: terraform apply -auto-approve

      - name: Terraform destroy (destroy)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: terraform destroy -auto-approve

      - name: Show outputs (create only)
        if: ${{ github.event.inputs.action == 'create' }}
        run: terraform output
###

      