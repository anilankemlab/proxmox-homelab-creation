- name: Install basic packages on Linux VM
  hosts: newvm
  become: yes
  gather_facts: yes

  tasks:
    ##################################################
    # Debian / Ubuntu
    ##################################################

    - name: Wait for automatic system updates to complete
      shell: |
        while fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
              fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
              fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do
          echo "Waiting for apt lock..."
          sleep 5
        done
      when: ansible_os_family == "Debian"

    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install basic packages (Debian/Ubuntu)
      apt:
        name:
          - unzip
          - tar
          - dnsutils
          - iputils-ping
          - traceroute
          - curl
          - wget
          - vim
          - net-tools
        state: present
      when: ansible_os_family == "Debian"

    ##################################################
    # CentOS / Rocky / AlmaLinux / RHEL
    ##################################################

    - name: Install basic packages (RedHat family)
      dnf:
        name:
          - unzip
          - tar
          - bind-utils
          - iputils
          - traceroute
          - curl
          - wget
          - vim
          - net-tools
        state: present
      when: ansible_os_family == "RedHat"

    ##################################################
    # Verify installation
    ##################################################

    - name: Verify nslookup
      command: nslookup google.com
      register: nslookup_test
      changed_when: false

    - name: Show nslookup result
      debug:
        var: nslookup_test.stdout_lines

    ##################################################
    # Push SSH Public Key
    ##################################################

    - name: Ensure anilankem user exists
      user:
        name: anilankem
        state: present
        create_home: yes

    - name: Add SSH key for root
      authorized_key:
        user: root
        state: present
        key: "{{ lookup('file', '/home/ansible/.ssh/mylab.pub') }}"

    - name: Add SSH key for anilankem
      authorized_key:
        user: anilankem
        state: present
        key: "{{ lookup('file', '/home/ansible/.ssh/mylab.pub') }}"

    - name: Allow anilankem passwordless sudo
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^anilankem ALL=.*NOPASSWD:ALL'
        line: 'anilankem ALL=(ALL) NOPASSWD:ALL'
      validate: 'visudo -cf %s'
